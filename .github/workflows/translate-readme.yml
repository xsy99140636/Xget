name: Translate README

on:
  push:
    branches: [main]
    paths:
      - "README.md"
  pull_request:
    branches: [main]
    paths:
      - "README.md"
  workflow_dispatch:

jobs:
  translate-readme:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js for chunked translation
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: |
          npm install deepl-node

      - name: Split and translate README in chunks
        run: |
          # åˆ›å»ºåˆ†å—ç¿»è¯‘è„šæœ¬
          cat > translate_chunks.js << 'EOF'
          const fs = require('fs');
          const { Translator } = require('deepl-node');

          const translator = new Translator(process.env.DEEPL_API_KEY);

          async function translateFile() {
            try {
              const content = fs.readFileSync('README.md', 'utf8');

              // æ™ºèƒ½åˆ†å—ï¼šæŒ‰æ®µè½å’Œæ ‡é¢˜åˆ†å‰²ï¼Œé¿å…ç ´åç»“æ„
              const sections = content.split(/(?=^#{1,6}\s)/m);
              const chunks = [];
              let currentChunk = '';
              const maxChunkSize = 3800; // å­—ç¬¦æ•°é™åˆ¶ï¼Œç•™æœ‰å®‰å…¨è¾¹é™…

              for (const section of sections) {
                if ((currentChunk + section).length > maxChunkSize && currentChunk) {
                  chunks.push(currentChunk.trim());
                  currentChunk = section;
                } else {
                  currentChunk += section;
                }
              }

              if (currentChunk.trim()) {
                chunks.push(currentChunk.trim());
              }

              console.log(`ğŸ“„ æ–‡ä»¶å¤§å°: ${content.length} å­—ç¬¦`);
              console.log(`ğŸ“¦ åˆ†ä¸º ${chunks.length} å—è¿›è¡Œç¿»è¯‘`);

              const translatedChunks = [];

              for (let i = 0; i < chunks.length; i++) {
                const chunkSize = chunks[i].length;
                console.log(`ğŸ”„ ç¿»è¯‘ç¬¬ ${i + 1}/${chunks.length} å— (${chunkSize} å­—ç¬¦)...`);

                try {
                  const result = await translator.translateText(
                    chunks[i],
                    'zh',
                    'en-US',
                    {
                      preserveFormatting: true,
                      tagHandling: 'html'
                    }
                  );
                  translatedChunks.push(result.text);
                  console.log(`âœ… ç¬¬ ${i + 1} å—ç¿»è¯‘å®Œæˆ`);

                  // æ·»åŠ å»¶è¿Ÿé¿å…APIé™åˆ¶
                  if (i < chunks.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 2000));
                  }
                } catch (error) {
                  console.error(`âŒ ç¿»è¯‘ç¬¬ ${i + 1} å—æ—¶å‡ºé”™:`, error.message);
                  // å¦‚æœç¿»è¯‘å¤±è´¥ï¼Œä¿ç•™åŸæ–‡å¹¶æ·»åŠ é”™è¯¯æ ‡è®°
                  translatedChunks.push(`<!-- ç¿»è¯‘å¤±è´¥ï¼Œä¿ç•™åŸæ–‡ -->\n${chunks[i]}`);
                }
              }

              const translatedContent = translatedChunks.join('\n\n');
              fs.writeFileSync('README.en.md', translatedContent);
              console.log('ğŸ‰ ç¿»è¯‘å®Œæˆï¼');

              // æ£€æŸ¥ç¿»è¯‘è´¨é‡
              const originalLines = content.split('\n').length;
              const translatedLines = translatedContent.split('\n').length;
              console.log(`ğŸ“Š åŸæ–‡è¡Œæ•°: ${originalLines}, è¯‘æ–‡è¡Œæ•°: ${translatedLines}`);

            } catch (error) {
              console.error('âŒ ç¿»è¯‘è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:', error);
              process.exit(1);
            }
          }

          translateFile();
          EOF

          # è¿è¡Œç¿»è¯‘è„šæœ¬
          node translate_chunks.js
        env:
          DEEPL_API_KEY: ${{ secrets.DEEPL_API_KEY }}

      - name: Update language link and add translation notice
        run: |
          if [ -f "README.en.md" ]; then
            # åˆ›å»ºä¸´æ—¶æ–‡ä»¶
            temp_file=$(mktemp)

            # è¯»å–ç¿»è¯‘åçš„æ–‡ä»¶å†…å®¹
            content=$(cat README.en.md)

            # æ›¿æ¢è¯­è¨€é“¾æ¥ï¼šå°† [English](README.en.md) æ”¹ä¸º [æ±‰è¯­](README.md)
            content=$(echo "$content" | sed 's/\*\*\[English\](README\.en\.md)\*\*/\*\*\[æ±‰è¯­\](README\.md)\*\*/g')

            # åœ¨ç¬¬ä¸‰è¡Œï¼ˆè¯­è¨€é“¾æ¥åï¼‰æ’å…¥ç¿»è¯‘è¯´æ˜
            echo "$content" | awk '
            NR==1 {print $0}
            NR==2 {print $0; print ""}
            NR==3 {
              print $0
              print ""
              print "> **ğŸ“ ç¿»è¯‘è¯´æ˜**"
              print ">"
              print "> æœ¬æ–‡æ¡£ç”± [DeepL](https://www.deepl.com/) è‡ªåŠ¨ç¿»è¯‘ç”Ÿæˆï¼Œå¦‚æœ‰ç–æ¼æˆ–é”™è¯¯ï¼Œè¯·ä»¥ [ä¸­æ–‡åŸæ–‡](README.md) ä¸ºå‡†ã€‚"
              print ">"
              print "> This document is automatically translated by [DeepL](https://www.deepl.com/). For any omissions or errors, please refer to the [original Chinese text](README.md)."
              print ""
              next
            }
            NR>3 {print $0}
            ' > "$temp_file"

            # æ›¿æ¢åŸæ–‡ä»¶
            mv "$temp_file" README.en.md
          fi

      - name: Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          if [ -f "README.en.md" ]; then
            git add README.en.md
            if git diff --staged --quiet; then
              echo "No changes to commit"
            else
              # è®¡ç®—æ–‡ä»¶ç»Ÿè®¡ä¿¡æ¯
              original_lines=$(wc -l < README.md)
              translated_lines=$(wc -l < README.en.md)

              git commit -m "ğŸŒ Auto-translate README.md to English using DeepL (Chunked)

              ğŸ“„ Processed large README.md in chunks for optimal translation quality
              ğŸ“Š Original: ${original_lines} lines â†’ Translated: ${translated_lines} lines
              âœ¨ Features:
              - Generated README.en.md from README.md
              - Updated language links
              - Added translation disclaimer
              - Intelligent chunk processing to maintain structure

              Co-authored-by: DeepL <https://www.deepl.com/>"
              git push
            fi
          fi

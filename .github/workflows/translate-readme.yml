name: Translate README

on:
  push:
    branches: [main]
    paths:
      - "README.md"
  pull_request:
    branches: [main]
    paths:
      - "README.md"
  workflow_dispatch:

jobs:
  translate-readme:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Translate README to English
        uses: lyqht/deepl-translate-github-action@v2.1.1
        with:
          deepl_api_key: ${{ secrets.DEEPL_API_KEY }}
          target_languages: en
          input_file_path: README.md
          output_file_name_pattern: README.{language}.md

      - name: Update language link and add translation notice
        run: |
          if [ -f "README.en.md" ]; then
            # åˆ›å»ºä¸´æ—¶æ–‡ä»¶
            temp_file=$(mktemp)

            # è¯»å–ç¿»è¯‘åçš„æ–‡ä»¶å†…å®¹
            content=$(cat README.en.md)

            # æ›¿æ¢è¯­è¨€é“¾æ¥ï¼šå°† [English](README.en.md) æ”¹ä¸º [æ±‰è¯­](README.md)
            content=$(echo "$content" | sed 's/\*\*\[English\](README\.en\.md)\*\*/\*\*\[æ±‰è¯­\](README\.md)\*\*/g')

            # åœ¨ç¬¬ä¸‰è¡Œï¼ˆè¯­è¨€é“¾æ¥åï¼‰æ’å…¥ç¿»è¯‘è¯´æ˜
            echo "$content" | awk '
            NR==1 {print $0}
            NR==2 {print $0; print ""}
            NR==3 {
              print $0
              print ""
              print "> **ğŸ“ ç¿»è¯‘è¯´æ˜**"
              print ">"
              print "> æœ¬æ–‡æ¡£ç”± [DeepL](https://www.deepl.com/) è‡ªåŠ¨ç¿»è¯‘ç”Ÿæˆï¼Œå¦‚æœ‰ç–æ¼æˆ–é”™è¯¯ï¼Œè¯·ä»¥ [ä¸­æ–‡åŸæ–‡](README.md) ä¸ºå‡†ã€‚"
              print ">"
              print "> This document is automatically translated by [DeepL](https://www.deepl.com/). For any omissions or errors, please refer to the [original Chinese text](README.md)."
              print ""
              next
            }
            NR>3 {print $0}
            ' > "$temp_file"

            # æ›¿æ¢åŸæ–‡ä»¶
            mv "$temp_file" README.en.md
          fi

      - name: Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          if [ -f "README.en.md" ]; then
            git add README.en.md
            if git diff --staged --quiet; then
              echo "No changes to commit"
            else
              git commit -m "ğŸŒ Auto-translate README.md to English using DeepL

              - Generated README.en.md from README.md
              - Updated language links
              - Added translation disclaimer

              Co-authored-by: DeepL <https://www.deepl.com/>"
              git push
            fi
          fi
